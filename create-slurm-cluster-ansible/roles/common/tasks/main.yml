---
# Ensure host's system hostname matches the inventory name and /etc/hosts contains the mapping
- name: Set system hostname according to inventory
  become: true
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Ensure /etc/hosts contains all inventory host mappings
  become: true
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item].ansible_host | default(hostvars[item].ansible_default_ipv4.address | default('127.0.0.1')) }} {{ item }}"
    regexp: '(^|\s){{ item }}($|\s)'
    state: present
    create: yes
    backup: yes
  loop: "{{ groups['all'] }}"
  loop_control:
    label: "{{ item }}"

- name: Add controller fingerprint to control host known_hosts (run locally once)
  run_once: true
  delegate_to: localhost
  ansible.builtin.known_hosts:
    path: "{{ lookup('env','HOME') + '/.ssh/known_hosts' }}"
    name: "{{ hostvars['controller'].ansible_host | default(hostvars['controller'].inventory_hostname) }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -H ' + (hostvars['controller'].ansible_host | default(hostvars['controller'].inventory_hostname))) }}"
    state: present

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install base packages
  apt:
    name:
      - chrony
      - vim
      - python3
      - python3-apt
      - build-essential
      - apt-transport-https
      - ca-certificates
    state: present

- name: Ensure slurm user exists
  user:
    name: "{{ slurm_user }}"
    system: yes
    createhome: no

- name: Ensure root's .ssh directory exists
  become: true
  file:
    path: "{{ ansible_env.HOME + '/.ssh' }}"
    state: directory
    mode: "0700"
    owner: root
    group: root

- name: Ensure controller host key is present on target nodes
  become: true
  ansible.builtin.known_hosts:
    path: "{{ ansible_env.HOME + '/.ssh/known_hosts' }}"
    name: "{{ hostvars['controller'].ansible_host | default(hostvars['controller'].inventory_hostname) }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -H ' + (hostvars['controller'].ansible_host | default(hostvars['controller'].inventory_hostname))) }}"
    state: present
