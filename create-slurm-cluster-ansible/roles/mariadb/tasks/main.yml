---
- name: Install MariaDB server and python MySQL deps
  apt:
    name:
      - mariadb-server
      - mariadb-client
      - python3-pymysql
    state: present
    update_cache: yes

- name: Ensure MariaDB service is enabled and started
  service:
    name: mariadb
    state: started
    enabled: true

- name: Deploy basic my.cnf for slurmdb
  copy:
    content: |
      [mysqld]
      bind-address = {{ mariadb_bind_address }}
      max_connections = 200
      innodb_lock_wait_timeout = 900
      innodb_buffer_pool_size = 4G
      character-set-server = utf8mb4
      collation-server = utf8mb4_general_ci
    dest: /etc/mysql/mariadb.conf.d/99-slurm.cnf
    owner: root
    group: root
    mode: '0644'
  notify: restart mariadb

- name: Wait for mariadb to be ready
  wait_for:
    port: "{{ slurmdbd_storage_port }}"
    host: "{{ mariadb_bind_address if mariadb_bind_address != '0.0.0.0' else '127.0.0.1' }}"
    timeout: 30

- name: Ensure root password is set (allow socket login then set)
  block:
    - name: Try to set root password via unix socket (socket auth)
      become: true
      mysql_user:
        login_user: root
        login_unix_socket: /run/mysqld/mysqld.sock
        name: root
        host_all: yes
        password: "{{ mariadb_root_password }}"
        login_password: "{{ mariadb_root_password }}"
      register: set_root_via_socket
      ignore_errors: yes

    - name: Fallback â€” set root password by running mysql CLI as system root (if socket method failed)
      when: set_root_via_socket is failed
      become: true
      shell: |
        mysql --protocol=socket -uroot -S /run/mysqld/mysqld.sock -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ mariadb_root_password }}'; FLUSH PRIVILEGES;"
      args:
        executable: /bin/bash 
    
- name: Create slurm accounting database
  mysql_db:
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    name: "{{ slurmdbd_dbname }}"
    state: present

- name: Create slurmdbd user and grant privileges
  mysql_user:
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    name: "{{ slurmdbd_user }}"
    password: "{{ slurmdbd_password }}"
    host: "%"
    priv: "{{ slurmdbd_dbname }}.*:ALL"
    state: present

- name: Flush privileges
  mysql_query:
    login_user: root
    login_password: "{{ mariadb_root_password }}"
    query: "FLUSH PRIVILEGES;"
